<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ajax | note-lib</title>
    <meta name="description" content="一个学习仓库">
    <link rel="icon" href="/note-lib/favicon.ico">
    
    <link rel="preload" href="/note-lib/assets/css/0.styles.9cfd74a3.css" as="style"><link rel="preload" href="/note-lib/assets/js/app.552cd09f.js" as="script"><link rel="preload" href="/note-lib/assets/js/2.79fbbef4.js" as="script"><link rel="preload" href="/note-lib/assets/js/18.1f676136.js" as="script"><link rel="prefetch" href="/note-lib/assets/js/10.ee873c39.js"><link rel="prefetch" href="/note-lib/assets/js/11.2d59e4b6.js"><link rel="prefetch" href="/note-lib/assets/js/12.b948c3b6.js"><link rel="prefetch" href="/note-lib/assets/js/13.7babcbbc.js"><link rel="prefetch" href="/note-lib/assets/js/14.102dfebf.js"><link rel="prefetch" href="/note-lib/assets/js/15.46d6a84d.js"><link rel="prefetch" href="/note-lib/assets/js/16.45a4b6c9.js"><link rel="prefetch" href="/note-lib/assets/js/17.2d250d08.js"><link rel="prefetch" href="/note-lib/assets/js/19.cf4792f1.js"><link rel="prefetch" href="/note-lib/assets/js/20.16e855a8.js"><link rel="prefetch" href="/note-lib/assets/js/21.4c1de8f1.js"><link rel="prefetch" href="/note-lib/assets/js/22.1c0f45ab.js"><link rel="prefetch" href="/note-lib/assets/js/23.322c7390.js"><link rel="prefetch" href="/note-lib/assets/js/24.899ea01e.js"><link rel="prefetch" href="/note-lib/assets/js/25.75b3664b.js"><link rel="prefetch" href="/note-lib/assets/js/26.df6fb79e.js"><link rel="prefetch" href="/note-lib/assets/js/27.fb9aae20.js"><link rel="prefetch" href="/note-lib/assets/js/28.3f12ab5f.js"><link rel="prefetch" href="/note-lib/assets/js/29.37eabf75.js"><link rel="prefetch" href="/note-lib/assets/js/3.12846cbb.js"><link rel="prefetch" href="/note-lib/assets/js/30.381232a0.js"><link rel="prefetch" href="/note-lib/assets/js/31.5541885c.js"><link rel="prefetch" href="/note-lib/assets/js/4.402d097d.js"><link rel="prefetch" href="/note-lib/assets/js/5.03c14cff.js"><link rel="prefetch" href="/note-lib/assets/js/6.03bd1427.js"><link rel="prefetch" href="/note-lib/assets/js/7.ee8fb7fe.js"><link rel="prefetch" href="/note-lib/assets/js/8.10e40c46.js"><link rel="prefetch" href="/note-lib/assets/js/9.b6304540.js">
    <link rel="stylesheet" href="/note-lib/assets/css/0.styles.9cfd74a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note-lib/zh/" class="home-link router-link-active"><!----> <span class="site-name">note-lib</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note-lib/zh/es/" class="nav-link router-link-active">ES</a></div><div class="nav-item"><a href="/note-lib/zh/blog/" class="nav-link">博客</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-lib/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/note-lib/zh/es/Ajax.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <a href="https://github.com/wentiansky/note-lib" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note-lib/zh/es/" class="nav-link router-link-active">ES</a></div><div class="nav-item"><a href="/note-lib/zh/blog/" class="nav-link">博客</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-lib/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/note-lib/zh/es/Ajax.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <a href="https://github.com/wentiansky/note-lib" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>起步</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note-lib/zh/es/" class="sidebar-link">ECMA-Script</a></li><li><a href="/note-lib/zh/es/js-basic.html" class="sidebar-link">JS基础内容</a></li><li><a href="/note-lib/zh/es/object-oriented.html" class="sidebar-link">面向对象</a></li><li><a href="/note-lib/zh/es/BOM.html" class="sidebar-link">BOM对象</a></li><li><a href="/note-lib/zh/es/DOM1.html" class="sidebar-link">DOM1</a></li><li><a href="/note-lib/zh/es/DOM2.html" class="sidebar-link">DOM2样式</a></li><li><a href="/note-lib/zh/es/event.html" class="sidebar-link">Event 事件</a></li><li><a href="/note-lib/zh/es/HTML5脚本编程.html" class="sidebar-link">HTML5 脚本编程</a></li><li><a href="/note-lib/zh/es/JSON.html" class="sidebar-link">JSON</a></li><li><a href="/note-lib/zh/es/Ajax.html" class="active sidebar-link">Ajax</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_1-xmlhttprequest-对象" class="sidebar-link">1. XMLHttpRequest 对象</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_2-http-头部信息" class="sidebar-link">2. HTTP 头部信息</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_3-get-请求" class="sidebar-link">3. GET 请求</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_4-post-请求" class="sidebar-link">4. POST 请求</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_5-xmlhttprequest-2-级" class="sidebar-link">5. XMLHttpRequest 2 级</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_5-1-formdata" class="sidebar-link">5.1 FormData</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_5-2-timeout" class="sidebar-link">5.2 timeout</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_5-3-overridemimetype-方法" class="sidebar-link">5.3 overrideMimeType()方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_6-进度事件" class="sidebar-link">6. 进度事件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_6-1-load-事件" class="sidebar-link">6.1 load 事件</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_6-2-progress-事件" class="sidebar-link">6.2 progress 事件</a></li></ul></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_7-跨域资源共享（cors）" class="sidebar-link">7. 跨域资源共享（CORS）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_7-1-ie-对-cors-的实现" class="sidebar-link">7.1 IE 对 CORS 的实现</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_7-2-其他浏览器对-cors-的实现" class="sidebar-link">7.2 其他浏览器对 CORS 的实现</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_7-3-preflighted-requests（预检请求）" class="sidebar-link">7.3 Preflighted Requests（预检请求）</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_7-4-带凭据的请求" class="sidebar-link">7.4 带凭据的请求</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_7-5-跨浏览器的-cors" class="sidebar-link">7.5 跨浏览器的 CORS</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_7-6-其他跨域技术" class="sidebar-link">7.6 其他跨域技术</a></li></ul></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_8-comet-服务端推送" class="sidebar-link">8. Comet 服务端推送</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_9-服务器发送事件" class="sidebar-link">9. 服务器发送事件</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/es/Ajax.html#_10-web-sockets" class="sidebar-link">10. Web Sockets</a></li></ul></li><li><a href="/note-lib/zh/es/error-debug.html" class="sidebar-link">错误处理与调试</a></li><li><a href="/note-lib/zh/es/vedio-material.html" class="sidebar-link">学习视频</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ajax"><a href="#ajax" aria-hidden="true" class="header-anchor">#</a> Ajax</h1> <h2 id="_1-xmlhttprequest-对象"><a href="#_1-xmlhttprequest-对象" aria-hidden="true" class="header-anchor">#</a> 1. XMLHttpRequest 对象</h2> <p>创建 XHR 对象</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> XMLHttpRequest <span class="token operator">!=</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> ActiveXObject <span class="token operator">!=</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> arguments<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>activeXString <span class="token operator">!=</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> versions <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token string">'MSXML2.XMLHttp.6.0'</span><span class="token punctuation">,</span>
        <span class="token string">'MSXML.XMLHttp.3.0'</span><span class="token punctuation">,</span>
        <span class="token string">'MSXML.XMLHttp'</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> versions<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span>versions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
          arguments<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>activeXString <span class="token operator">=</span> versions<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
          <span class="token keyword">break</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'跳过循环'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ActiveXObject</span><span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>activeXString<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'No XHR object available.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>XHR</strong>对象的<code>readyState</code>属性，表示请求/响应过程的当前活动阶段</p> <ul><li>0：未初始化，尚未调用 open()方法</li> <li>1：启动，已经调用 open()方法，但尚未调用 send()方法</li> <li>2：发送，已经调用 send()方法，但尚未接收到响应</li> <li>3：接收，已经接收到部分响应数据</li> <li>4：完成，已经接收到全部响应数据，而且可以再客户端使用了</li></ul> <p><code>readState</code>属性的值从一个变成另外一个值，都会触发一次<code>onreadystatechange</code>事件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token function">createXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'request was unsuccessful: '</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'example.txt'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// true表示异步请求</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_2-http-头部信息"><a href="#_2-http-头部信息" aria-hidden="true" class="header-anchor">#</a> 2. HTTP 头部信息</h2> <p>每个 HTTP 请求和响应都会有头部信息，在发送<code>XHR</code>请求的同时，还会发送以下头部信息</p> <ul><li>Accept：浏览器能够处理的内容类型；</li> <li>Accept-Charset：浏览器能够显示的字符集；</li> <li>Accept-Encoding：浏览器能够处理的压缩编码；</li> <li>Accept-Language：浏览器当前设置的语言；</li> <li>Connetction：浏览器与服务器之期的连接类型；</li> <li>Cookie：当前页面设置的任何 Cookie；</li> <li>Host：发出请求的页面所在的域；</li> <li>Referer：发出请求页面的 URI，正确写法是<code>referrer</code>，HTTP 规范写错了；</li> <li>User-Agent：浏览器的用户代理字符串；</li></ul> <blockquote><p>调用<code>XHR</code>的<code>setRequestHeader()</code>方法可以设置请求头部信息，需要在<code>send()</code>方法前调用</p></blockquote> <div class="language-jsx extra-class"><pre class="language-jsx"><code>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'MyHeader'</span><span class="token punctuation">,</span> <span class="token string">'MyValue'</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_3-get-请求"><a href="#_3-get-请求" aria-hidden="true" class="header-anchor">#</a> 3. GET 请求</h2> <p>使用一下函数可以向现有<code>url</code>的末尾添加查询参数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">addURLParam</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> name<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  url <span class="token operator">+=</span> url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string">'?'</span> <span class="token punctuation">:</span> <span class="token string">'&amp;'</span>
  url <span class="token operator">+=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token keyword">return</span> url
<span class="token punctuation">}</span>

<span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token string">'example.php'</span>

<span class="token comment">// 添加参数</span>
url <span class="token operator">=</span> <span class="token function">addURLParam</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'jax'</span><span class="token punctuation">)</span>
url <span class="token operator">=</span> <span class="token function">addURLParam</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">'remark'</span><span class="token punctuation">,</span> <span class="token string">'Aa,./=[]{} 123'</span><span class="token punctuation">)</span>

<span class="token comment">// 初始化请求</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_4-post-请求"><a href="#_4-post-请求" aria-hidden="true" class="header-anchor">#</a> 4. POST 请求</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 表单序列化</span>
<span class="token keyword">function</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token parameter">form</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> parts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    field <span class="token operator">=</span> <span class="token keyword">null</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> form<span class="token punctuation">.</span>elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    field <span class="token operator">=</span> form<span class="token punctuation">.</span>elements<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">'select-one'</span><span class="token punctuation">:</span>
      <span class="token keyword">case</span> <span class="token string">'select-multiple'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span>name<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> field<span class="token punctuation">.</span>options<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> option <span class="token operator">=</span> field<span class="token punctuation">.</span>options<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>option<span class="token punctuation">.</span>selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">var</span> optValue <span class="token operator">=</span> <span class="token string">''</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>option<span class="token punctuation">.</span>hasAttribute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                optValue <span class="token operator">=</span> option<span class="token punctuation">.</span><span class="token function">hasAttribute</span><span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">)</span>
                  <span class="token operator">?</span> option<span class="token punctuation">.</span>value
                  <span class="token punctuation">:</span> option<span class="token punctuation">.</span>text
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                optValue <span class="token operator">=</span> option<span class="token punctuation">.</span>attributes<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>specified
                  <span class="token operator">?</span> option<span class="token punctuation">.</span>value
                  <span class="token punctuation">:</span> option<span class="token punctuation">.</span>text
              <span class="token punctuation">}</span>
              parts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
                <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">+</span>
                  <span class="token string">'='</span> <span class="token operator">+</span>
                  <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>optValue<span class="token punctuation">)</span>
              <span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span>

      <span class="token keyword">case</span> <span class="token keyword">undefined</span><span class="token punctuation">:</span> <span class="token comment">// 字段集</span>
      <span class="token keyword">case</span> <span class="token string">'file'</span><span class="token punctuation">:</span> <span class="token comment">// 文件输入</span>
      <span class="token keyword">case</span> <span class="token string">'submit'</span><span class="token punctuation">:</span> <span class="token comment">// 提交按钮</span>
      <span class="token keyword">case</span> <span class="token string">'reset'</span><span class="token punctuation">:</span> <span class="token comment">// 充值按钮</span>
      <span class="token keyword">case</span> <span class="token string">'button'</span><span class="token punctuation">:</span> <span class="token comment">// 自定义按钮</span>
        <span class="token keyword">break</span>

      <span class="token keyword">case</span> <span class="token string">'radio'</span><span class="token punctuation">:</span>
      <span class="token keyword">case</span> <span class="token string">'checkbox'</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>field<span class="token punctuation">.</span>checked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
      <span class="token comment">// 执行默认操作</span>

      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token comment">// 不包含没有名字的表单字段</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span>name<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          parts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
            <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">+</span>
              <span class="token string">'='</span> <span class="token operator">+</span>
              <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> parts<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// post请求模仿表单提交</span>
<span class="token keyword">var</span> form <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'user-info'</span><span class="token punctuation">)</span>

xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'example.php'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'application/x-www-form-urlencoded'</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_5-xmlhttprequest-2-级"><a href="#_5-xmlhttprequest-2-级" aria-hidden="true" class="header-anchor">#</a> 5. XMLHttpRequest 2 级</h2> <h3 id="_5-1-formdata"><a href="#_5-1-formdata" aria-hidden="true" class="header-anchor">#</a> 5.1 FormData</h3> <p><code>FormData</code>为序列化表单以及创建表单相同的数据（用于通过 XHR 传输）提供了便利，可以使用<code>append()</code>方法向对象添加键值对，也可以向构造函数传入表单元素，可以直接传入<code>xhr.send()</code>方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> data1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>form<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> data2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

data2<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'jax'</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> form <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'user-info'</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'example.php'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span>form<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>使用<code>FormData</code>的方便之处就是不必在<code>xhr</code>对象上设置请求头部</p> <h3 id="_5-2-timeout"><a href="#_5-2-timeout" aria-hidden="true" class="header-anchor">#</a> 5.2 timeout</h3> <p><code>IE8+</code>为<code>XHR</code>对象添加了一个<code>timeout</code>属性，在设置时间未收到响应会停止请求。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token function">createXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 为避免超时终止请求之后再访问xhr.status，使用try-catch</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Request was unsuccessful: '</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'example.php'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token number">1000</span>
xhr<span class="token punctuation">.</span><span class="token function-variable function">ontimeout</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Request did not return in a second.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_5-3-overridemimetype-方法"><a href="#_5-3-overridemimetype-方法" aria-hidden="true" class="header-anchor">#</a> 5.3 overrideMimeType()方法</h3> <p>通过<code>overrideMimeType()</code>方法重写响应类型。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token function">createXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'example.php'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">overrideMimeType</span><span class="token punctuation">(</span><span class="token string">'text/xml'</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_6-进度事件"><a href="#_6-进度事件" aria-hidden="true" class="header-anchor">#</a> 6. 进度事件</h2> <h3 id="_6-1-load-事件"><a href="#_6-1-load-事件" aria-hidden="true" class="header-anchor">#</a> 6.1 load 事件</h3> <p>只要浏览器接收到服务器的响应，就会触发<code>load</code>事件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token function">createXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">&lt;</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Request was unsuccessful: '</span> <span class="token operator">+</span> xhr<span class="token punctuation">.</span>status<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'example.php'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_6-2-progress-事件"><a href="#_6-2-progress-事件" aria-hidden="true" class="header-anchor">#</a> 6.2 progress 事件</h3> <ul><li><code>lengthComputable</code>：表示进度信息是否可用（Boolean）</li> <li><code>position</code>：表示已接收的字节数</li> <li><code>totalSize</code>：表示根据<code>Content-Length</code>响应头部确定的预期字节数</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token function">createXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> divStatus <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'status'</span><span class="token punctuation">)</span>

xhr<span class="token punctuation">.</span><span class="token function-variable function">onprogress</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lengthComputable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    divStatus<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span>
      <span class="token string">'Received '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>position <span class="token operator">+</span> <span class="token string">' of '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>totalSize <span class="token operator">+</span> <span class="token string">'bytes'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'example.php'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_7-跨域资源共享（cors）"><a href="#_7-跨域资源共享（cors）" aria-hidden="true" class="header-anchor">#</a> 7. 跨域资源共享（CORS）</h2> <blockquote><p>默认情况下<code>XHR</code>对象只能访问与包含他的页面位于同一个域中的资源，来源于跨域安全策略。<code>CORS</code>（Cross-Origin-Resource Sharing，跨域资源共享），使用自定义的<code>HTTP</code>头部让浏览器与服务器进行沟通。</p></blockquote> <p>如发送一个简单的<code>GET</code>或<code>POST</code>请求时，需要附加一个额外的<code>origin</code>头部，包含页面的源信息（协议、域名和端口），以便服务器根据这个头部信息来决定是否给予响应。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 浏览器的头部信息</span>
origin<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com

<span class="token comment">// 服务端的添加允许的响应头</span>
Access<span class="token operator">-</span>Control<span class="token operator">-</span>Allow<span class="token operator">-</span>Origin<span class="token punctuation">:</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com
</code></pre></div><h3 id="_7-1-ie-对-cors-的实现"><a href="#_7-1-ie-对-cors-的实现" aria-hidden="true" class="header-anchor">#</a> 7.1 IE 对 CORS 的实现</h3> <p><code>IE8</code>引入了<code>XDR</code>（XDomainRequest）类型，与<code>XHR</code>类似，但能实现安全的跨域通信，有一下特点：</p> <ul><li><code>cookie</code>不会随请求发送，也不会随响应返回</li> <li>只能设置请求头部信息中的<code>Content-type</code>字段</li> <li>不能访问响应头部信息</li> <li>只支持<code>GET</code>和<code>POST</code>请求
这些特点有效的缓解了<code>CSRF</code>（Cross-Site Request Forgery，跨站点请求伪造）和<code>XSS</code>（Cross-Site scripting，跨站点脚本）</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> xdr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XDomainRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

xdr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 只能访问到响应的原始文本，不能访问响应状态等其他信息</span>
  <span class="token function">alert</span><span class="token punctuation">(</span>xdr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
xdr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 响应错误时触发，没有多余的信息</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'An error occurred.'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// get请求</span>
xdr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'example.php'</span><span class="token punctuation">)</span> <span class="token comment">// 没有第三个参数，只能是异步</span>
xdr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>

<span class="token comment">// post 请求</span>
xdr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'post'</span><span class="token punctuation">,</span> <span class="token string">'example.php'</span><span class="token punctuation">)</span>
xdr<span class="token punctuation">.</span>contentType <span class="token operator">=</span> <span class="token string">'application/x-www-form-urlencoded'</span>
</code></pre></div><h3 id="_7-2-其他浏览器对-cors-的实现"><a href="#_7-2-其他浏览器对-cors-的实现" aria-hidden="true" class="header-anchor">#</a> 7.2 其他浏览器对 CORS 的实现</h3> <p>其他浏览器对<code>CORS</code>提供了原生支持，在 open()方法中使用绝对 URL 即可，与 IE 的<code>XDR</code>不同的是，通过跨域的<code>XHR</code>可以访问<code>status</code>和<code>statusText</code>属性，而且还支持同步请求，但是也有一些限制：</p> <ul><li>不能使用<code>setRequestHeader()</code>设置自定义头部</li> <li>不能发送和接受<code>cookie</code></li> <li>调用<code>getAllResponseHeader()</code>总是会返回空字符串</li></ul> <h3 id="_7-3-preflighted-requests（预检请求）"><a href="#_7-3-preflighted-requests（预检请求）" aria-hidden="true" class="header-anchor">#</a> 7.3 Preflighted Requests（预检请求）</h3> <p>支持开发人员自定义头部、GET 或 POST 之外的方法，以及不同类型的主体内容，在使用以下高级选项，会发送一个 preflighted 请求，IE10 及以下版本不支持 preflight 请求。</p> <ul><li><code>Origin</code>：与简单请求相同</li> <li><code>Access-Control-Request-method</code>：请求自身使用的方法</li> <li><code>Access-Control-Request-Headers</code>：自定义头部信息，多个头部以逗号分隔</li></ul> <p>服务器通过在响应头中发送如下头部与浏览器进行沟通：</p> <ul><li><code>Access-Control-Allow-Origin</code>：与简单的请求相同</li> <li><code>Access-Control-Allow-Methods</code>：允许的方法，多个方法以逗号隔开</li> <li><code>Access-Control-Allow-Headers</code>：允许的头部，多个头部以逗号隔开</li> <li><code>Access-Control-Max-Age</code>：应该讲这个<code>Preflight</code>请求缓存多长时间</li></ul> <h3 id="_7-4-带凭据的请求"><a href="#_7-4-带凭据的请求" aria-hidden="true" class="header-anchor">#</a> 7.4 带凭据的请求</h3> <p>默认情况系，跨域请求不提供凭据（cookie、HTTP 认证及客户端 SSL 证明等），设置<code>withCredentials</code>为 true 可以指定某个请求应该发送凭据，如果服务器接收带凭据的请求，会用下面的 HTTP 头部来响应：</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code>Access<span class="token operator">-</span>control<span class="token operator">-</span>Allow<span class="token operator">-</span>Credentials<span class="token punctuation">:</span> <span class="token boolean">true</span>
</code></pre></div><h3 id="_7-5-跨浏览器的-cors"><a href="#_7-5-跨浏览器的-cors" aria-hidden="true" class="header-anchor">#</a> 7.5 跨浏览器的 CORS</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createCORSRequest</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token function">createXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'withCredentials'</span> <span class="token keyword">in</span> xhr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 支持XHR跨域</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> XDomainRequest <span class="token operator">!=</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XDomainRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    xhr <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> xhr
<span class="token punctuation">}</span>

<span class="token keyword">var</span> request <span class="token operator">=</span> <span class="token function">createCORSRequest</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'example.php'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  request<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 对request.responseText进行处理</span>
  <span class="token punctuation">}</span>
  request<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-6-其他跨域技术"><a href="#_7-6-其他跨域技术" aria-hidden="true" class="header-anchor">#</a> 7.6 其他跨域技术</h3> <h4 id="_7-6-1-图像-ping"><a href="#_7-6-1-图像-ping" aria-hidden="true" class="header-anchor">#</a> 7.6.1 图像 Ping</h4> <p>使用<code>&lt;img&gt;</code>标签，一个网页可以从任何网页中加载图像，动态创建图像经常用于图像 Ping，图像 Ping 是与服务器进行<strong>简单、单向</strong>的跨域通信的一种方式，请求的数据通过查询字符串形式发送，浏览器得不到任何具体的数据，但通过侦听<code>onload</code>和<code>onerror</code>事件，能知道响应是什么时候接收到的，常用来跟踪用户点击页面或动态广告曝光次数。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> img <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

img<span class="token punctuation">.</span>onload <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'done!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
img<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'example.php?name=&quot;jax&quot;'</span>
</code></pre></div><h4 id="_7-6-2-jsonp"><a href="#_7-6-2-jsonp" aria-hidden="true" class="header-anchor">#</a> 7.6.2 JSONP</h4> <blockquote><p>JSONP 是 JSON with padding 的简写，是包含在函数中的 JSON。由回调函数和数据两部分组成，回调函数的名字一般在请求中指定，数据就是传入回调函数中的 JSON 数据，如：</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">handleResponse</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'result: '</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span>
script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://test.com/json/?callback=handleResponse'</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>script<span class="token punctuation">,</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>firstChild<span class="token punctuation">)</span>
</code></pre></div><p>与图像 ping 相比的优势是能访问到服务端响应，缺点是其他域可能不安全，没有失败的回调函数。</p> <h2 id="_8-comet-服务端推送"><a href="#_8-comet-服务端推送" aria-hidden="true" class="header-anchor">#</a> 8. Comet 服务端推送</h2> <blockquote><p>实现方式：长轮询和流，长轮询是短轮询的翻版，等待发送响应。流在页面的整个生命周期内只使用一个 HTTP 连接，客户端实现流的方式如下：</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createStreamingClient</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> progress<span class="token punctuation">,</span> finished</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">var</span> received <span class="token operator">=</span> <span class="token number">0</span>

  xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result

    <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">.</span><span class="token function">subString</span><span class="token punctuation">(</span>received<span class="token punctuation">)</span>
      received <span class="token operator">+=</span> result<span class="token punctuation">.</span>length
      <span class="token function">progress</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">finished</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> xhr
<span class="token punctuation">}</span>

<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token function">createStreamingClient</span><span class="token punctuation">(</span>
  <span class="token string">'example.php'</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Received: '</span> <span class="token operator">+</span> data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fsys</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'done!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><h2 id="_9-服务器发送事件"><a href="#_9-服务器发送事件" aria-hidden="true" class="header-anchor">#</a> 9. 服务器发送事件</h2> <blockquote><p>SSE（Server-Sent Events）服务器发送事件。
API有：</p></blockquote> <ul><li>open：建立连接时触发</li> <li>message：从服务器接收到新事件触发</li> <li>error：无法建立连接时触发</li> <li>close：关闭连接</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">'myevents.php'</span><span class="token punctuation">)</span>

source<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> event<span class="token punctuation">.</span>data
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_10-web-sockets"><a href="#_10-web-sockets" aria-hidden="true" class="header-anchor">#</a> 10. Web Sockets</h2> <blockquote><p>在持久连接上提供全双工、双向通信，建立一个http连接后，从<code>HTTP</code>协议升级成<code>Web Socket</code>协议，自定义的<code>ws://</code>协议传输数据小，适合移动端通信。</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://www.example.com/server.php'</span><span class="token punctuation">)</span>

<span class="token comment">// 发送数据</span>
socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>

<span class="token comment">// 获取服务端消息</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> data <span class="token operator">=</span> event<span class="token punctuation">.</span>data
<span class="token punctuation">}</span>

<span class="token comment">// 关闭</span>
socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/wentiansky/note-lib/edit/master/docs/zh/es/Ajax.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2020-4-27 21:04:17</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/note-lib/zh/es/JSON.html" class="prev">
          JSON
        </a></span> <span class="next"><a href="/note-lib/zh/es/error-debug.html">
          错误处理与调试
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note-lib/assets/js/app.552cd09f.js" defer></script><script src="/note-lib/assets/js/2.79fbbef4.js" defer></script><script src="/note-lib/assets/js/18.1f676136.js" defer></script>
  </body>
</html>
