<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>进化的倒计时 | note-lib</title>
    <meta name="description" content="一个学习仓库">
    <link rel="icon" href="/note-lib/favicon.ico">
    
    <link rel="preload" href="/note-lib/assets/css/0.styles.9cfd74a3.css" as="style"><link rel="preload" href="/note-lib/assets/js/app.552cd09f.js" as="script"><link rel="preload" href="/note-lib/assets/js/2.79fbbef4.js" as="script"><link rel="preload" href="/note-lib/assets/js/13.7babcbbc.js" as="script"><link rel="prefetch" href="/note-lib/assets/js/10.ee873c39.js"><link rel="prefetch" href="/note-lib/assets/js/11.2d59e4b6.js"><link rel="prefetch" href="/note-lib/assets/js/12.b948c3b6.js"><link rel="prefetch" href="/note-lib/assets/js/14.102dfebf.js"><link rel="prefetch" href="/note-lib/assets/js/15.46d6a84d.js"><link rel="prefetch" href="/note-lib/assets/js/16.45a4b6c9.js"><link rel="prefetch" href="/note-lib/assets/js/17.2d250d08.js"><link rel="prefetch" href="/note-lib/assets/js/18.1f676136.js"><link rel="prefetch" href="/note-lib/assets/js/19.cf4792f1.js"><link rel="prefetch" href="/note-lib/assets/js/20.16e855a8.js"><link rel="prefetch" href="/note-lib/assets/js/21.4c1de8f1.js"><link rel="prefetch" href="/note-lib/assets/js/22.1c0f45ab.js"><link rel="prefetch" href="/note-lib/assets/js/23.322c7390.js"><link rel="prefetch" href="/note-lib/assets/js/24.899ea01e.js"><link rel="prefetch" href="/note-lib/assets/js/25.75b3664b.js"><link rel="prefetch" href="/note-lib/assets/js/26.df6fb79e.js"><link rel="prefetch" href="/note-lib/assets/js/27.fb9aae20.js"><link rel="prefetch" href="/note-lib/assets/js/28.3f12ab5f.js"><link rel="prefetch" href="/note-lib/assets/js/29.37eabf75.js"><link rel="prefetch" href="/note-lib/assets/js/3.12846cbb.js"><link rel="prefetch" href="/note-lib/assets/js/30.381232a0.js"><link rel="prefetch" href="/note-lib/assets/js/31.5541885c.js"><link rel="prefetch" href="/note-lib/assets/js/4.402d097d.js"><link rel="prefetch" href="/note-lib/assets/js/5.03c14cff.js"><link rel="prefetch" href="/note-lib/assets/js/6.03bd1427.js"><link rel="prefetch" href="/note-lib/assets/js/7.ee8fb7fe.js"><link rel="prefetch" href="/note-lib/assets/js/8.10e40c46.js"><link rel="prefetch" href="/note-lib/assets/js/9.b6304540.js">
    <link rel="stylesheet" href="/note-lib/assets/css/0.styles.9cfd74a3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/note-lib/zh/" class="home-link router-link-active"><!----> <span class="site-name">note-lib</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/note-lib/zh/es/" class="nav-link">ES</a></div><div class="nav-item"><a href="/note-lib/zh/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-lib/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/note-lib/zh/blog/进化的倒计时.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/wentiansky/note-lib" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/note-lib/zh/es/" class="nav-link">ES</a></div><div class="nav-item"><a href="/note-lib/zh/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/note-lib/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/note-lib/zh/blog/进化的倒计时.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/wentiansky/note-lib" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>博客</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note-lib/zh/blog/" class="sidebar-link">我的一些文章和总结</a></li><li><a href="/note-lib/zh/blog/进化的倒计时.html" class="active sidebar-link">进化的倒计时</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/note-lib/zh/blog/进化的倒计时.html#写在前面" class="sidebar-link">写在前面</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/blog/进化的倒计时.html#工具函数" class="sidebar-link">工具函数</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/blog/进化的倒计时.html#小试牛刀的第一版倒计时" class="sidebar-link">小试牛刀的第一版倒计时</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/blog/进化的倒计时.html#循序渐进的第二版倒计时" class="sidebar-link">循序渐进的第二版倒计时</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/blog/进化的倒计时.html#相对稳定的第三版倒计时" class="sidebar-link">相对稳定的第三版倒计时</a></li><li class="sidebar-sub-header"><a href="/note-lib/zh/blog/进化的倒计时.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/note-lib/zh/blog/项目总结.html" class="sidebar-link">项目总结</a></li><li><a href="/note-lib/zh/blog/ie11请求兼容.html" class="sidebar-link">ie11请求兼容：</a></li><li><a href="/note-lib/zh/blog/JS.html" class="sidebar-link">JS基础1</a></li><li><a href="/note-lib/zh/blog/v-if组件重新加载问题.html" class="sidebar-link">v-if+watch 监听\$route+router-view 导致组件重新加载问题</a></li><li><a href="/note-lib/zh/blog/vue-cli3兼容ie.html" class="sidebar-link">vue cli3 兼容 IE9+</a></li><li><a href="/note-lib/zh/blog/vue项目-权限管理组件开发总结.html" class="sidebar-link">vue 项目-权限管理组件开发总结</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="进化的倒计时"><a href="#进化的倒计时" aria-hidden="true" class="header-anchor">#</a> 进化的倒计时</h1> <h2 id="写在前面"><a href="#写在前面" aria-hidden="true" class="header-anchor">#</a> 写在前面</h2> <p>最近接到产品的需求，需要在系统的订单模块-未付费列表上增加一列倒计时显示，订单到期后系统会自动关闭订单，作为开发人员的我其实是拒绝的，但是你还是得做吧，除非哪一天我中了彩票，我就可以理直气壮的拒绝了（~~~收），回到主题，下面开始我的倒计时进化之旅（期待^^^）</p> <h2 id="工具函数"><a href="#工具函数" aria-hidden="true" class="header-anchor">#</a> 工具函数</h2> <p>我们项目使用的vue，在我开始真正的写业务逻辑前，我会封装一下需要用到的工具函数，没办法呀，要有全局观嘛（墨镜+大金链子.png）</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// src/utils/index.js </span>
<span class="token comment">/** 
 * 将时间戳转换成时分秒，例如08:14:20
 * @param {number} ms 时间戳
 * 
 */</span>
<span class="token function">formatTimeStamp</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> hours <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>ms <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    minutes <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ms <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    seconds <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ms <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hours <span class="token operator">=</span> hours <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">?</span> <span class="token string">'0'</span> <span class="token operator">+</span> hours <span class="token punctuation">:</span> hours<span class="token punctuation">;</span>
    minutes <span class="token operator">=</span> minutes <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">?</span> <span class="token string">'0'</span> <span class="token operator">+</span> minutes <span class="token punctuation">:</span> minutes<span class="token punctuation">;</span>
    seconds <span class="token operator">=</span> seconds <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">?</span> <span class="token string">'0'</span> <span class="token operator">+</span> seconds <span class="token punctuation">:</span> seconds<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hours<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>minutes<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>seconds<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h2 id="小试牛刀的第一版倒计时"><a href="#小试牛刀的第一版倒计时" aria-hidden="true" class="header-anchor">#</a> 小试牛刀的第一版倒计时</h2> <p>身为web前端的我们，首先都不用带脑子想的，我肯定首选<code>setInterval</code>的，开始撸代码呀：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">destroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
<span class="token comment">/* 获取未付费订单列表数据 */</span>
  <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listLoading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">getList</span><span class="token punctuation">(</span><span class="token string">&quot;/order_not_pay&quot;</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>orderList <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pageLtotal <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>total<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>listLoading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有数据</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 开始倒计时</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/* 倒计时 */</span>
  <span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>updateTime<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/* 更新时间 */</span>
  <span class="token function">updateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token constant">DAYS</span> <span class="token operator">=</span> <span class="token number">259200000</span><span class="token punctuation">,</span> <span class="token comment">// 订单3天后过期</span>
      endSeconds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
      endTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>orderList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        endSeconds <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>created_at<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">DAYS</span> <span class="token operator">-</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endSeconds <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 时间到</span>
          Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">&quot;endTime&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;已逾期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          endTime <span class="token operator">=</span> <span class="token function">formatTimeStamp</span><span class="token punctuation">(</span>endSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
          Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">&quot;endTime&quot;</span><span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于是项目中的部分代码，其中一些变量没有详细写出来，大致思路就是拿到列表数据后，启用setInterval定时器，每次循环一遍orderList，根据订单创建时间（created_at）加上3天减去当前时间，得到剩余时间，转换格式，我在组件卸载钩子函数中销毁定时器，注意要用windows，之前用this调用就是不起作用，哈哈哈，this指向的是Vue啦。欧拉，提交代码，告诉测试妹子可以测一下了，等待中（应该是没有bug的吧，渍渍...）。</p> <h2 id="循序渐进的第二版倒计时"><a href="#循序渐进的第二版倒计时" aria-hidden="true" class="header-anchor">#</a> 循序渐进的第二版倒计时</h2> <p>没有bug是不可能滴，公司请你来干嘛，不就是写bug的嘛，惭愧惭愧。过了没多久，噩耗传来，测试妹子给我发消息说，你的定时器有问题哦，3天的话倒计时应该从72:00:00开始吧，你的是从72:02:00开始的。哦，世上竟有如此荒唐之事，待我一探究竟再给你答复，我第一个想到的是是不是服务器时间不准，因为之前我在测试服下单的时间就比正确的时间快两分钟，然后我就找到跟我对接的后端，问一下他是不是服务端时间不准哦，后端熟练的打开了终端，敲了几行我不是很懂的命令，最终显示的北京时间是正确的。咦，不科学，我脱口而出，为了寻找真相，我去到测试妹子旁边让她复现一下bug，在她操作的过程中，我把目光锁定在她屏幕右下角的时间栏，对比了一下我的手机时间，嗨呀，难怪，原来是她的电脑慢了两分钟，找到问题的根源后，回到座位，思考如何解决。
的确我计算取了本地时间，但我们不能保证用户电脑的时间都是准确的，为此我想到让后端返回当前时间，与本地时间取差值，每次减去这个差值即可。除了这个问题，我还发现了，列表的计时器偶尔会发生卡顿，与是查了一下setInteval和setTimeout相关资料，推荐做法是用setTimeout模拟setInterval，开始撸代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">destroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
<span class="token comment">/* 获取未付费订单列表数据 */</span>
  <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listLoading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">getList</span><span class="token punctuation">(</span><span class="token string">&quot;/order_not_pay&quot;</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>orderList <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pageLtotal <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>total<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>listLoading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有数据</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 开始倒计时</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/* 倒计时 */</span>
  <span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>updateTime<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/* 更新时间 */</span>
  <span class="token function">updateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token constant">DAYS</span> <span class="token operator">=</span> <span class="token number">259200000</span><span class="token punctuation">,</span> <span class="token comment">// 订单3天后过期</span>
      endSeconds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
      endTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token comment">// 计算服务器与本地的时间差</span>
      diffTime <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>orderList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>now_time<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>orderList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        endSeconds <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>created_at<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token constant">DAYS</span> <span class="token operator">-</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> diffTime<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endSeconds <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 时间到</span>
          Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">&quot;endTime&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;已逾期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          endTime <span class="token operator">=</span> <span class="token function">formatTimeStamp</span><span class="token punctuation">(</span>endSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
          Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">&quot;endTime&quot;</span><span class="token punctuation">,</span> endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>updateTime<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="相对稳定的第三版倒计时"><a href="#相对稳定的第三版倒计时" aria-hidden="true" class="header-anchor">#</a> 相对稳定的第三版倒计时</h2> <p>后来了解到了window.requestAnimationFrame(callback) api，一般用于css动画制作，根据屏幕的刷新频率执行回调函数，一般是1秒钟执行60此，相比用setTimeout而言，效率更高，当然存在兼容问题，目前方案是浏览器支持使用window.requestAnimationFrame，否则采用setTimeout，要使用window.requestAnimationFrame，需要先解决模拟一秒钟执行回调函数，开始撸代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  timer<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  lastTime<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 记录上一次的时间戳</span>
  options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    diffTime<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// 服务端与本地时间差值</span>
    days<span class="token punctuation">:</span> <span class="token number">259200000</span><span class="token punctuation">,</span> <span class="token comment">// 订单3天后过期</span>
    endSeconds<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
    endTime<span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token function">destroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
<span class="token comment">/* 获取未付费订单列表数据 */</span>
  <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>listLoading <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">getList</span><span class="token punctuation">(</span><span class="token string">&quot;/order_not_pay&quot;</span><span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>orderList <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pageLtotal <span class="token operator">=</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>total<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>listLoading <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 没有数据</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 计算服务器与本地的时间差</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>diffTime <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>now_time<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 当使用requestAnimationFrame时，记录上一次时间戳</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lastTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 开始倒计时</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/* 倒计时 */</span>
  <span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>requestAnimationFrame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 浏览器支持requestAnimationFrame</span>
      window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>animationCb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 用setTimeout兼容</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>setTimeoutCb<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/* setTimeout调函数 */</span>
  <span class="token function">setTimeoutCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>setTimeoutCb<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/* requestAnimationFrame回调函数 */</span>
  <span class="token function">animationCb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastTime <span class="token operator">&gt;=</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lastTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>animationCb<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">/* 更新时间 */</span>
  <span class="token function">updateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>endSeconds <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>created_at<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>days <span class="token operator">-</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>diffTime<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>endSeconds <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 时间到</span>
          Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">&quot;endTime&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;已逾期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>endTime <span class="token operator">=</span> utils<span class="token punctuation">.</span><span class="token function">formatTimeStamp</span><span class="token punctuation">(</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>endSeconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
          Vue<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">&quot;endTime&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>通过这次做倒计时功能，让我对<code>setInterval</code>和<code>setTimeout</code>和<code>window.requestAnimationFrame</code>有了更深层次的理解，因为js是单线程，存在时间循环机制，只有当任务队列为空时，才会执行setInterval，setTimeout等宏任务，因此计算时间可能不准确，window.requestAnimationFrame相对来说性能更好,并且支持GPU加速。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/wentiansky/note-lib/edit/master/docs/zh/blog/进化的倒计时.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">2019-8-2 11:14:41</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/note-lib/zh/blog/" class="prev router-link-active">
          我的一些文章和总结
        </a></span> <span class="next"><a href="/note-lib/zh/blog/项目总结.html">
          项目总结
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/note-lib/assets/js/app.552cd09f.js" defer></script><script src="/note-lib/assets/js/2.79fbbef4.js" defer></script><script src="/note-lib/assets/js/13.7babcbbc.js" defer></script>
  </body>
</html>
